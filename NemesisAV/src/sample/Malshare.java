package sample;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;


public class Malshare extends Download {

    private String apiUrl;
    private String token;

    private String md5List;

    public Malshare() {
        apiUrl = "https://malshare.com/api.php";
        token = "7d11307405d92f5c8a3757ab2ab2a3a56410dcf62313c3d604e7952a8e3a91b0";
    }

    public String getListRaw() throws IOException {
        String urlPath = URLUtils.addParameter(apiUrl,"api_key", token);
        urlPath = URLUtils.addParameter(urlPath,"action", "getlistraw");

        URL url = new URL(urlPath);
        HttpURLConnection connection = (HttpURLConnection) url.openConnection();

        connection.setRequestMethod("GET");
        connection.setRequestProperty("User-Agent", "Mozilla/5.0");

        int responseCode = connection.getResponseCode();
        System.out.println("ResponseCode : " + responseCode);

        BufferedReader in = new BufferedReader(new InputStreamReader(connection.getInputStream()));
        String inputLine;
        StringBuffer response = new StringBuffer();
        while ((inputLine = in.readLine()) != null) {
            response.append(inputLine);
            response.append("\n");
        }
        in.close();

        md5List = response.toString();

        connection.disconnect();

        return md5List;
    }

    public void getFile() throws IOException {
        String dirName = "";

        String [] md5 = md5List.split("\n");

        for(String downloadMd5 : md5){
            String urlPath = URLUtils.addParameter(apiUrl,"api_key", token);
            urlPath = URLUtils.addParameter(urlPath,"action", "getfile");
            urlPath = URLUtils.addParameter(urlPath, "hash", downloadMd5);

            Download.downloadUsingNIO(urlPath, dirName + "" + downloadMd5);
        }
    }
}
